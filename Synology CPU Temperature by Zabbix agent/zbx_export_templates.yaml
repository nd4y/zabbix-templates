zabbix_export:
  version: '7.0'
  template_groups:
    - uuid: 7c2cb727f85b492d88cd56e17127c64d
      name: Templates/SAN
  templates:
    - uuid: 0e0c766c273b4ac892691a18a9f04e87
      template: 'Synology CPU Temperature by Zabbix agent'
      name: 'Synology CPU Temperature by Zabbix agent'
      groups:
        - name: Templates/SAN
      discovery_rules:
        - uuid: cd89ff410f8a4ffcb30646d5523f9f11
          name: 'CPU Temperture Discovery'
          key: 'system.run[for label in /sys/devices/platform/coretemp.0/hwmon/hwmon0/temp*_label; do label_content=$(cat $label); echo "$label_content"; input="${label/_label/_input}"; echo "$input"; done]'
          delay: 1h
          item_prototypes:
            - uuid: 8684724842a243d987d563a390413212
              name: 'CPU {#CPU_LABEL} Temperature'
              key: 'vfs.file.contents[{#CPU_TEMPERATURE_FILE}]'
              delay: 15s
              units: Â°C
              preprocessing:
                - type: STR_REPLACE
                  parameters:
                    - '000'
                    - ''
              trigger_prototypes:
                - uuid: ea55dbb49e0f407eb1fa330e7d94582a
                  expression: 'last(/Synology CPU Temperature by Zabbix agent/vfs.file.contents[{#CPU_TEMPERATURE_FILE}])>{$CPU_TEMP_CRIT}'
                  recovery_mode: RECOVERY_EXPRESSION
                  recovery_expression: 'last(/Synology CPU Temperature by Zabbix agent/vfs.file.contents[{#CPU_TEMPERATURE_FILE}])<({$CPU_TEMP_CRIT}-5)'
                  name: 'CPU {#CPU_LABEL} Temperture > {$CPU_TEMP_CRIT}'
                  priority: HIGH
                - uuid: 94f319ee810e433e97ba877565d2f8c3
                  expression: 'last(/Synology CPU Temperature by Zabbix agent/vfs.file.contents[{#CPU_TEMPERATURE_FILE}])>{$CPU_TEMP_WARN}'
                  recovery_mode: RECOVERY_EXPRESSION
                  recovery_expression: 'last(/Synology CPU Temperature by Zabbix agent/vfs.file.contents[{#CPU_TEMPERATURE_FILE}])<({$CPU_TEMP_WARN}-5)'
                  name: 'CPU {#CPU_LABEL} Temperture > {$CPU_TEMP_WARN}'
                  priority: WARNING
                  dependencies:
                    - name: 'CPU {#CPU_LABEL} Temperture > {$CPU_TEMP_CRIT}'
                      expression: 'last(/Synology CPU Temperature by Zabbix agent/vfs.file.contents[{#CPU_TEMPERATURE_FILE}])>{$CPU_TEMP_CRIT}'
                      recovery_expression: 'last(/Synology CPU Temperature by Zabbix agent/vfs.file.contents[{#CPU_TEMPERATURE_FILE}])<({$CPU_TEMP_CRIT}-5)'
          preprocessing:
            - type: JAVASCRIPT
              parameters:
                - |
                  var result = [];
                  var data = value.trim().split('\n');
                  for (var i = 0; i < data.length; i += 2) {
                    var obj = {
                      "{#CPU_LABEL}": data[i],
                      "{#CPU_TEMPERATURE_FILE}": data[i + 1]
                    };
                    result.push(obj);
                  }
                  return JSON.stringify(result);
      macros:
        - macro: '{$CPU_TEMP_CRIT}'
          value: '70'
        - macro: '{$CPU_TEMP_WARN}'
          value: '60'
